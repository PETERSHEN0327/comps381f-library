<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Loans</title>
<link rel="stylesheet" href="/style.css"></head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Loans</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <a href="/books" class="btn btn-secondary">&laquo; Books</a>
        <a href="/my/loans" class="btn btn-secondary">My Loans</a>
        <% if (user.role === 'admin') { %>
          <a href="/loans/create" class="btn btn-primary">+ New Loan</a>
          <a href="/admin/dashboard" class="btn btn-secondary">Dashboard</a>
        <% } %>
        <form method="post" action="/logout" style="margin-left:auto">
          <button class="btn btn-secondary">Logout</button>
        </form>
      </div>

      <% if (!loans.length) { %>
        <p style="margin-top:14px;">No loans.</p>
      <% } else { %>
      <table class="table">
        <tr><th>Book</th><th>Borrower</th><th>Loaned</th><th>Due</th><th>Returned</th><th>Action</th></tr>
        <% loans.forEach(l => { %>
          <tr>
            <td><%= l.book ? l.book.title : '-' %></td>
            <td><%= l.borrower %></td>
            <td><%= new Date(l.loanedAt).toLocaleDateString() %></td>
            <td><%= new Date(l.dueDate).toLocaleDateString() %></td>
            <td><%= l.returnedAt ? new Date(l.returnedAt).toLocaleDateString() : '-' %></td>
            <td>
              <% if (!l.returnedAt && (user.role === 'admin' || user.username === l.borrower)) { %>
                <form method="post" action="/loans/<%= l._id %>/return">
                  <button class="btn btn-edit">Mark Returned</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </table>
      <% } %>

      <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
        <div class="pagination">
          <a class="<%= page===1?'disabled':'' %>" href="/loans?page=<%= page-1 %>">Prev</a>
          <% for (let p=1; p<=totalPages; p++){ %>
            <% if (p === page) { %>
              <span class="active"><%= p %></span>
            <% } else { %>
              <a href="/loans?page=<%= p %>"><%= p %></a>
            <% } %>
          <% } %>
          <a class="<%= page===totalPages?'disabled':'' %>" href="/loans?page=<%= page+1 %>">Next</a>
        </div>
      <% } %>
    </div>
  </div>
</body>
</html>
